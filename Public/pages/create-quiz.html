<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuizWhiz+ - Create Quiz</title>
    <link rel="stylesheet" href="../styles/dashboard.css">
    <link rel="stylesheet" href="../styles/create-quiz.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap">
</head>
<body>
    <div class="dashboard-container">
        <div id="sidebar"></div>
        <main class="main-content">
            <div id="dashboard-header"></div>
            <!-- Dashboard Content -->
            <div class="dashboard-content">
                <div class="welcome-banner">
                    <div class="welcome-text">
                        <h1>Create a New Quiz</h1>
                        <p>Design your own quiz with custom questions and share it with the community.</p>
                    </div>
                    <div class="quick-actions">
                        <a href="#templates" class="btn btn-outline">Use Template</a>
                        <a href="#import" class="btn btn-outline">Import Questions</a>
                    </div>
                </div>

                <!-- Steps Progress -->
                <div class="steps-container">
                    <div class="step-item completed">
                        <div class="step-number">1</div>
                        <div class="step-title">Basic Info</div>
                    </div>
                    <div class="step-item active">
                        <div class="step-number">2</div>
                        <div class="step-title">Questions</div>
                    </div>
                    <div class="step-item">
                        <div class="step-number">3</div>
                        <div class="step-title">Settings</div>
                    </div>
                    <div class="step-item">
                        <div class="step-number">4</div>
                        <div class="step-title">Preview</div>
                    </div>
                    <div class="step-item">
                        <div class="step-number">5</div>
                        <div class="step-title">Publish</div>
                    </div>
                </div>

                <!-- Create Quiz Form -->
                <div class="create-quiz-container">
                    <!-- Basic Info Section -->
                    <div class="form-section">
                        <h2 class="form-section-title">Basic Information</h2>
                        <div class="form-group">
                            <label for="quiz-title">Quiz Title</label>
                            <input type="text" id="quiz-title" class="form-input" placeholder="Enter a catchy title for your quiz" value="Science Quiz: Exploring the Natural World">
                        </div>
                        <div class="form-group">
                            <label for="quiz-description">Description</label>
                            <textarea id="quiz-description" class="form-textarea" placeholder="Describe what your quiz is about">Test your knowledge of various scientific concepts, from biology and chemistry to physics and astronomy. This quiz covers a wide range of topics in the natural sciences.</textarea>
                        </div>
                        <div class="form-row">
                            <div class="form-col">
                                <label for="quiz-category">Category</label>
                                <select id="quiz-category" class="form-select">
                                    <option value="">Select a category</option>
                                    <option value="science" selected>Science</option>
                                    <option value="history">History</option>
                                    <option value="math">Mathematics</option>
                                    <option value="literature">Literature</option>
                                    <option value="geography">Geography</option>
                                    <option value="technology">Technology</option>
                                    <option value="arts">Arts</option>
                                    <option value="sports">Sports</option>
                                </select>
                            </div>
                            <div class="form-col">
                                <label for="quiz-difficulty">Difficulty Level</label>
                                <select id="quiz-difficulty" class="form-select">
                                    <option value="">Select difficulty</option>
                                    <option value="easy">Easy</option>
                                    <option value="medium" selected>Medium</option>
                                    <option value="hard">Hard</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Cover Image</label>
                            <div class="image-upload">
                                <div class="upload-icon">üì∑</div>
                                <p class="upload-text">Drag and drop an image here, or click to browse</p>
                                <label class="upload-btn">
                                    Browse Files
                                    <input type="file" style="display: none;" accept="image/*">
                                </label>
                            </div>
                            <p class="form-hint">Recommended size: 1200 x 630 pixels. Max file size: 5MB.</p>
                        </div>
                    </div>

                    <!-- Questions Section -->
                    <div class="form-section">
                        <h2 class="form-section-title">Questions</h2>
                        <div class="questions-container">
                            <!-- Question 1 -->
                            <div class="question-card">
                                <div class="question-header">
                                    <span class="question-number">Question 1</span>
                                    <div class="question-actions">
                                        <button type="button" class="question-action-btn">üîÑ</button>
                                        <button type="button" class="question-action-btn delete-btn">üóëÔ∏è</button>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="question-1-text">Question Text</label>
                                    <input type="text" id="question-1-text" class="form-input" placeholder="Enter your question" value="What is the chemical symbol for gold?">
                                </div>
                                <div class="form-group">
                                    <label>Options (select the correct answer)</label>
                                    <div class="options-container">
                                        <div class="option-row">
                                            <input type="radio" name="question-1-correct" class="option-radio" checked>
                                            <input type="text" class="option-input" placeholder="Option 1" value="Au">
                                            <button type="button" class="option-delete">‚úï</button>
                                        </div>
                                        <div class="option-row">
                                            <input type="radio" name="question-1-correct" class="option-radio">
                                            <input type="text" class="option-input" placeholder="Option 2" value="Ag">
                                            <button type="button" class="option-delete">‚úï</button>
                                        </div>
                                        <div class="option-row">
                                            <input type="radio" name="question-1-correct" class="option-radio">
                                            <input type="text" class="option-input" placeholder="Option 3" value="Fe">
                                            <button type="button" class="option-delete">‚úï</button>
                                        </div>
                                        <div class="option-row">
                                            <input type="radio" name="question-1-correct" class="option-radio">
                                            <input type="text" class="option-input" placeholder="Option 4" value="Gd">
                                            <button type="button" class="option-delete">‚úï</button>
                                        </div>
                                    </div>
                                    <button type="button" class="add-option-btn">+ Add Option</button>
                                </div>
                                <div class="form-group">
                                    <label for="question-1-explanation">Explanation (Optional)</label>
                                    <textarea id="question-1-explanation" class="form-textarea" placeholder="Explain the correct answer">Au is the chemical symbol for gold, derived from the Latin word 'aurum'.</textarea>
                                </div>
                            </div>

                            <!-- Question 2 -->
                            <div class="question-card">
                                <div class="question-header">
                                    <span class="question-number">Question 2</span>
                                    <div class="question-actions">
                                        <button type="button" class="question-action-btn">üîÑ</button>
                                        <button type="button" class="question-action-btn delete-btn">üóëÔ∏è</button>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="question-2-text">Question Text</label>
                                    <input type="text" id="question-2-text" class="form-input" placeholder="Enter your question" value="Which planet is known as the Red Planet?">
                                </div>
                                <div class="form-group">
                                    <label>Options (select the correct answer)</label>
                                    <div class="options-container">
                                        <div class="option-row">
                                            <input type="radio" name="question-2-correct" class="option-radio">
                                            <input type="text" class="option-input" placeholder="Option 1" value="Venus">
                                            <button type="button" class="option-delete">‚úï</button>
                                        </div>
                                        <div class="option-row">
                                            <input type="radio" name="question-2-correct" class="option-radio" checked>
                                            <input type="text" class="option-input" placeholder="Option 2" value="Mars">
                                            <button type="button" class="option-delete">‚úï</button>
                                        </div>
                                        <div class="option-row">
                                            <input type="radio" name="question-2-correct" class="option-radio">
                                            <input type="text" class="option-input" placeholder="Option 3" value="Jupiter">
                                            <button type="button" class="option-delete">‚úï</button>
                                        </div>
                                        <div class="option-row">
                                            <input type="radio" name="question-2-correct" class="option-radio">
                                            <input type="text" class="option-input" placeholder="Option 4" value="Saturn">
                                            <button type="button" class="option-delete">‚úï</button>
                                        </div>
                                    </div>
                                    <button type="button" class="add-option-btn">+ Add Option</button>
                                </div>
                                <div class="form-group">
                                    <label for="question-2-explanation">Explanation (Optional)</label>
                                    <textarea id="question-2-explanation" class="form-textarea" placeholder="Explain the correct answer">Mars is known as the Red Planet due to its reddish appearance, which is caused by iron oxide (rust) on its surface.</textarea>
                                </div>
                            </div>

                            <!-- Question 3 -->
                            <div class="question-card">
                                <div class="question-header">
                                    <span class="question-number">Question 3</span>
                                    <div class="question-actions">
                                        <button type="button" class="question-action-btn">üîÑ</button>
                                        <button type="button" class="question-action-btn delete-btn">üóëÔ∏è</button>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="question-3-text">Question Text</label>
                                    <input type="text" id="question-3-text" class="form-input" placeholder="Enter your question" value="What is the process by which plants make their own food using sunlight?">
                                </div>
                                <div class="form-group">
                                    <label>Options (select the correct answer)</label>
                                    <div class="options-container">
                                        <div class="option-row">
                                            <input type="radio" name="question-3-correct" class="option-radio" checked>
                                            <input type="text" class="option-input" placeholder="Option 1" value="Photosynthesis">
                                            <button type="button" class="option-delete">‚úï</button>
                                        </div>
                                        <div class="option-row">
                                            <input type="radio" name="question-3-correct" class="option-radio">
                                            <input type="text" class="option-input" placeholder="Option 2" value="Respiration">
                                            <button type="button" class="option-delete">‚úï</button>
                                        </div>
                                        <div class="option-row">
                                            <input type="radio" name="question-3-correct" class="option-radio">
                                            <input type="text" class="option-input" placeholder="Option 3" value="Transpiration">
                                            <button type="button" class="option-delete">‚úï</button>
                                        </div>
                                        <div class="option-row">
                                            <input type="radio" name="question-3-correct" class="option-radio">
                                            <input type="text" class="option-input" placeholder="Option 4" value="Germination">
                                            <button type="button" class="option-delete">‚úï</button>
                                        </div>
                                    </div>
                                    <button type="button" class="add-option-btn">+ Add Option</button>
                                </div>
                                <div class="form-group">
                                    <label for="question-3-explanation">Explanation (Optional)</label>
                                    <textarea id="question-3-explanation" class="form-textarea" placeholder="Explain the correct answer">Photosynthesis is the process by which green plants and some other organisms use sunlight to synthesize foods with carbon dioxide and water, generating oxygen as a byproduct.</textarea>
                                </div>
                            </div>
                        </div>

                        <button type="button" class="add-question-btn">+ Add New Question</button>
                    </div>

                    <!-- Quiz Settings Section -->
                    <div class="form-section">
                        <h2 class="form-section-title">Quiz Settings</h2>
                        <div class="form-row">
                            <div class="form-col">
                                <label for="time-limit">Time Limit</label>
                                <select id="time-limit" class="form-select">
                                    <option value="none">No Time Limit</option>
                                    <option value="5">5 minutes</option>
                                    <option value="10" selected>10 minutes</option>
                                    <option value="15">15 minutes</option>
                                    <option value="20">20 minutes</option>
                                    <option value="30">30 minutes</option>
                                    <option value="60">1 hour</option>
                                </select>
                            </div>
                            <div class="form-col">
                                <label for="passing-score">Passing Score (%)</label>
                                <select id="passing-score" class="form-select">
                                    <option value="50">50%</option>
                                    <option value="60">60%</option>
                                    <option value="70" selected>70%</option>
                                    <option value="80">80%</option>
                                    <option value="90">90%</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Quiz Options</label>
                            <div class="checkbox-group">
                                <div class="checkbox-item">
                                    <input type="checkbox" id="randomize-questions" checked>
                                    <label for="randomize-questions">Randomize Questions</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="randomize-options" checked>
                                    <label for="randomize-options">Randomize Options</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="show-correct-answers" checked>
                                    <label for="show-correct-answers">Show Correct Answers After Completion</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="show-explanations" checked>
                                    <label for="show-explanations">Show Explanations</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="allow-retakes" checked>
                                    <label for="allow-retakes">Allow Retakes</label>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Privacy Settings</label>
                            <div class="radio-group">
                                <div class="radio-item">
                                    <input type="radio" name="privacy" id="privacy-public" checked>
                                    <label for="privacy-public">Public (Anyone can take this quiz)</label>
                                </div>
                                <div class="radio-item">
                                    <input type="radio" name="privacy" id="privacy-unlisted">
                                    <label for="privacy-unlisted">Unlisted (Only accessible via link)</label>
                                </div>
                                <div class="radio-item">
                                    <input type="radio" name="privacy" id="privacy-private">
                                    <label for="privacy-private">Private (Only you can access)</label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="form-actions">
                        <div class="form-actions-left">
                            <button type="button" class="btn btn-outline">Save as Draft</button>
                            <button type="button" class="btn btn-outline">Preview</button>
                        </div>
                        <div class="form-actions-right">
                            <button type="button" class="btn btn-outline">Back</button>
                            <button type="button" class="btn btn-primary">Next: Settings</button>
                        </div>
                    </div>
                </div>

                <!-- Preview Section -->
                <div class="preview-section">
                    <div class="preview-header">
                        <h2 class="preview-title">Quiz Preview</h2>
                        <button type="button" class="btn btn-outline">Full Screen Preview</button>
                    </div>
                    <div class="preview-quiz">
                        <h2 class="preview-quiz-title">Science Quiz: Exploring the Natural World</h2>
                        <p class="preview-quiz-description">Test your knowledge of various scientific concepts, from biology and chemistry to physics and astronomy. This quiz covers a wide range of topics in the natural sciences.</p>
                        <div class="preview-quiz-meta">
                            <span>üìö Category: Science</span>
                            <span>üîÑ Difficulty: Medium</span>
                            <span>‚è±Ô∏è Time Limit: 10 minutes</span>
                            <span>‚ùì Questions: 3</span>
                        </div>
                        <div class="preview-question">
                            <p class="preview-question-text">1. What is the chemical symbol for gold?</p>
                            <div class="preview-options">
                                <div class="preview-option">
                                    <span class="preview-option-letter">A</span>
                                    <span>Au</span>
                                </div>
                                <div class="preview-option">
                                    <span class="preview-option-letter">B</span>
                                    <span>Ag</span>
                                </div>
                                <div class="preview-option">
                                    <span class="preview-option-letter">C</span>
                                    <span>Fe</span>
                                </div>
                                <div class="preview-option">
                                    <span class="preview-option-letter">D</span>
                                    <span>Gd</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Load shared sidebar and header, then fetch user
        function loadComponent(id, url, callback) {
            fetch(url).then(r => r.text()).then(html => {
                document.getElementById(id).innerHTML = html;
                if (callback) callback();
            });
        }
        async function fetchHeaderUser() {
            try {
                const response = await fetch('/QuizWhiz-web-app/api/get_current_user.php', { credentials: 'include' });
                const data = await response.json();
                if (response.ok && data.user && data.user.email) {
                    document.getElementById('user-email').textContent = data.user.email;
                } else {
                    document.getElementById('user-email').textContent = 'Not logged in';
                }
            } catch (e) {
                document.getElementById('user-email').textContent = 'Not logged in';
            }
        }
        document.addEventListener('DOMContentLoaded', function() {
            loadComponent('sidebar', '/QuizWhiz-web-app/components/sidebar.html');
            loadComponent('dashboard-header', '/QuizWhiz-web-app/components/header.html', fetchHeaderUser);

            // Mobile menu toggle
            const menuToggle = document.getElementById('menu-toggle');
            const sidebar = document.querySelector('.sidebar');
            
            menuToggle.addEventListener('click', function() {
                sidebar.classList.toggle('active');
                menuToggle.classList.toggle('active');
            });

            // Close sidebar when clicking outside on mobile
            document.addEventListener('click', function(event) {
                if (window.innerWidth <= 992) {
                    if (!sidebar.contains(event.target) && !menuToggle.contains(event.target)) {
                        sidebar.classList.remove('active');
                        menuToggle.classList.remove('active');
                    }
                }
            });

            // Add Question Button
            const addQuestionBtn = document.querySelector('.add-question-btn');
            const questionsContainer = document.querySelector('.questions-container');
            
            addQuestionBtn.addEventListener('click', function() {
                const questionCount = document.querySelectorAll('.question-card').length + 1;
                
                const newQuestion = document.createElement('div');
                newQuestion.className = 'question-card';
                newQuestion.innerHTML = `
                    <div class="question-header">
                        <span class="question-number">Question ${questionCount}</span>
                        <div class="question-actions">
                            <button type="button" class="question-action-btn">üîÑ</button>
                            <button type="button" class="question-action-btn delete-btn">üóëÔ∏è</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="question-${questionCount}-text">Question Text</label>
                        <input type="text" id="question-${questionCount}-text" class="form-input" placeholder="Enter your question">
                    </div>
                    <div class="form-group">
                        <label>Options (select the correct answer)</label>
                        <div class="options-container">
                            <div class="option-row">
                                <input type="radio" name="question-${questionCount}-correct" class="option-radio" checked>
                                <input type="text" class="option-input" placeholder="Option 1">
                                <button type="button" class="option-delete">‚úï</button>
                            </div>
                            <div class="option-row">
                                <input type="radio" name="question-${questionCount}-correct" class="option-radio">
                                <input type="text" class="option-input" placeholder="Option 2">
                                <button type="button" class="option-delete">‚úï</button>
                            </div>
                        </div>
                        <button type="button" class="add-option-btn">+ Add Option</button>
                    </div>
                    <div class="form-group">
                        <label for="question-${questionCount}-explanation">Explanation (Optional)</label>
                        <textarea id="question-${questionCount}-explanation" class="form-textarea" placeholder="Explain the correct answer"></textarea>
                    </div>
                `;
                
                questionsContainer.appendChild(newQuestion);
                
                // Add event listeners for the new question
                setupQuestionEventListeners(newQuestion);
            });

            // Setup event listeners for existing questions
            function setupQuestionEventListeners(questionCard) {
                // Delete question button
                const deleteBtn = questionCard.querySelector('.delete-btn');
                if (deleteBtn) {
                    deleteBtn.addEventListener('click', function() {
                        if (confirm('Are you sure you want to delete this question?')) {
                            questionCard.remove();
                            // Renumber questions
                            document.querySelectorAll('.question-card').forEach((card, index) => {
                                card.querySelector('.question-number').textContent = `Question ${index + 1}`;
                            });
                        }
                    });
                }

                // Add option button
                const addOptionBtn = questionCard.querySelector('.add-option-btn');
                const optionsContainer = questionCard.querySelector('.options-container');
                
                if (addOptionBtn && optionsContainer) {
                    addOptionBtn.addEventListener('click', function() {
                        const optionCount = optionsContainer.querySelectorAll('.option-row').length + 1;
                        const questionName = questionCard.querySelector('.option-radio').name;
                        
                        const newOption = document.createElement('div');
                        newOption.className = 'option-row';
                        newOption.innerHTML = `
                            <input type="radio" name="${questionName}" class="option-radio">
                            <input type="text" class="option-input" placeholder="Option ${optionCount}">
                            <button type="button" class="option-delete">‚úï</button>
                        `;
                        
                        optionsContainer.appendChild(newOption);
                        
                        // Add event listener for delete option button
                        const deleteOptionBtn = newOption.querySelector('.option-delete');
                        deleteOptionBtn.addEventListener('click', function() {
                            if (optionsContainer.querySelectorAll('.option-row').length > 2) {
                                newOption.remove();
                            } else {
                                alert('A question must have at least 2 options.');
                            }
                        });
                    });
                }

                // Delete option buttons
                const deleteOptionBtns = questionCard.querySelectorAll('.option-delete');
                deleteOptionBtns.forEach(btn => {
                    btn.addEventListener('click', function() {
                        const optionsContainer = this.closest('.options-container');
                        if (optionsContainer.querySelectorAll('.option-row').length > 2) {
                            this.closest('.option-row').remove();
                        } else {
                            alert('A question must have at least 2 options.');
                        }
                    });
                });
            }

            // Setup event listeners for all existing questions
            document.querySelectorAll('.question-card').forEach(questionCard => {
                setupQuestionEventListeners(questionCard);
            });

            // --- Quiz Creation Logic ---
            function collectQuizData() {
                // Basic Info
                const title = document.getElementById('quiz-title').value.trim();
                const description = document.getElementById('quiz-description').value.trim();
                const category = document.getElementById('quiz-category').value;
                const difficulty = document.getElementById('quiz-difficulty').value;
                let timeLimit = document.getElementById('time-limit').value;
                timeLimit = timeLimit === 'none' ? 0 : parseInt(timeLimit);

                // Questions
                const questionCards = document.querySelectorAll('.question-card');
                const questions = [];
                questionCards.forEach((card, idx) => {
                    const text = card.querySelector('.form-input').value.trim();
                    const type = 'multiple_choice'; // Only MC supported in UI
                    const points = 1; // You can extend this to be dynamic
                    const options = [];
                    const optionRows = card.querySelectorAll('.option-row');
                    optionRows.forEach((row, oidx) => {
                        const optText = row.querySelector('.option-input').value.trim();
                        const isCorrect = row.querySelector('.option-radio').checked;
                        if (optText) {
                            options.push({ text: optText, is_correct: isCorrect });
                        }
                    });
                    if (text && options.length >= 2) {
                        questions.push({ text, type, points, options });
                    }
                });

                return {
                    title,
                    description,
                    category,
                    difficulty,
                    time_limit: timeLimit,
                    questions
                };
            }

            async function submitQuiz() {
                const quizData = collectQuizData();
                if (!quizData.title || !quizData.category || !quizData.difficulty || quizData.questions.length === 0) {
                    alert('Please fill in all required fields and add at least one question.');
                    return;
                }
                try {
                    const response = await fetch('/QuizWhiz-web-app/api/create_quiz.php', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify(quizData)
                    });
                    const data = await response.json();
                    if (response.ok && data.success) {
                        alert('Quiz created successfully!');
                        window.location.href = 'my-quizzes.html';
                    } else {
                        alert('Failed to create quiz: ' + (data.error || 'Unknown error'));
                    }
                } catch (err) {
                    alert('Error creating quiz.');
                }
            }

            // Add a submit button at the end of the form if not present
            let submitBtn = document.getElementById('submit-quiz-btn');
            if (!submitBtn) {
                submitBtn = document.createElement('button');
                submitBtn.id = 'submit-quiz-btn';
                submitBtn.className = 'btn btn-primary';
                submitBtn.textContent = 'Create Quiz';
                document.querySelector('.form-actions-right').appendChild(submitBtn);
            }
            submitBtn.addEventListener('click', submitQuiz);
        });
    </script>
</body>
</html>
